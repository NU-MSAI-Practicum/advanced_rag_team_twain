from utils.db import es_conn
from langchain_community.embeddings import HuggingFaceEmbeddings

model = HuggingFaceEmbeddings(model_name="all-MiniLM-L6-v2")


def test_es():
    # Some useful apis
    # List all indexes in the elasticsearch
    idx_list = [x for x in es_conn.indices.get_alias("*").keys() ]
    print (idx_list)

    # Check if an index exists
    if es_conn.indices.exists(index="kibana_sample_data_ecommerce"):
        print ('index exists!')

    # Get documents in an index
    response = es_conn.search(index="kibana_sample_data_ecommerce", body={"query": {"match_all": {}}})
    for doc in response['hits']['hits']:
        print(doc['_source'])
    else:
        print("Document does not exist.")

def search_data(query, index_name, num_results=3):
    search_query = {
      "query": {
        "match": {
          "sentence": query
        }
      },
      "size": num_results
    }
    response = es_conn.search(index=index_name, body=search_query)
    for result_index, hit in enumerate(response['hits']['hits']):
        print("*** Top-"+str(result_index+1), "*** ID:", hit['_id'], ", Score:", hit['_score'], ", Sentence:", hit['_source']['sentence'])


def search_vector(query, index_name, num_results=3):
    vector = model.embed_query(query)
   # vector = [-0.008925613947212696, 0.02716585248708725, 0.023226123303174973, 0.03932545334100723, -0.0995681956410408, -0.0034529459662735462, -0.07788361608982086, 0.029876435175538063, -0.0798390582203865, -0.016280267387628555, 0.0024239986669272184, 0.041931360960006714, 0.002212038030847907, -0.07008066028356552, -0.049548447132110596, -0.010854884050786495, 0.034385938197374344, 0.017072642222046852, 0.003549218876287341, -0.026264449581503868, -0.06331368535757065, 0.005053195171058178, -0.014981926418840885, -0.04085385426878929, 0.13518045842647552, 0.026611054316163063, -0.006531093269586563, -0.0061724502593278885, -0.011727867648005486, -0.032838672399520874, 0.009044448845088482, -0.010985969565808773, 0.00433658342808485, 0.02552652545273304, 0.06266596913337708, -0.008795958943665028, 0.03339625522494316, 0.009680040180683136, 0.053704071789979935, -0.00977315939962864, 0.0480206124484539, 0.007832911796867847, -0.01807555928826332, 0.0061866831965744495, -0.05981704220175743, 0.05927427113056183, -0.018618492409586906, 0.0027535471599549055, 0.05337480455636978, 0.07595748454332352, 0.04945119470357895, 0.11297278106212616, -0.02206815592944622, 0.011249523609876633, 0.035346947610378265, 0.0908055305480957, -0.0029760103207081556, 0.008219434879720211, 0.07055854797363281, 0.016205012798309326, 0.061250247061252594, 0.019119417294859886, -0.11676076054573059, -0.0030832402408123016, -0.0071881976909935474, -0.08152168989181519, -0.015407323837280273, -0.09356513619422913, -0.007938613183796406, -0.09782085567712784, 0.09401024878025055, -0.00991034135222435, 0.042913999408483505, -0.10148358345031738, 0.024681175127625465, -0.034011028707027435, 0.10287676006555557, -0.04261231794953346, 0.024974625557661057, -0.061654284596443176, -0.004347310401499271, -0.008182693272829056, 0.07659091055393219, 0.03618936240673065, 0.019216332584619522, 0.03480188921093941, 0.035114139318466187, 0.07666323333978653, 0.09317893534898758, -0.008579603396356106, 0.0213262140750885, 0.00997492391616106, -0.07674767822027206, 0.0012968559749424458, -0.061911292374134064, -0.015278936363756657, -0.07487069815397263, 0.02300538681447506, 0.06611411273479462, 0.07421770691871643, -0.0037065353244543076, -0.01950090192258358, 0.04775077477097511, -0.02059539407491684, -0.04605845361948013, -0.032076820731163025, 0.028682883828878403, 0.05711348354816437, -0.08205756545066833, 0.007826320827007294, -0.06587854027748108, -0.036390312016010284, 0.0022728010080754757, -0.02367008849978447, 0.0335218608379364, -0.06970563530921936, 4.599861858878285e-05, -0.05003192275762558, 0.07090216875076294, -0.10262501984834671, 0.03682132810354233, 0.009644308127462864, 0.010479223914444447, -0.048912711441516876, 0.013323833234608173, -0.02847675420343876, -0.01987750083208084, -2.4111974304581964e-34, -0.053582917898893356, 0.015799326822161674, 0.0010849300306290388, -0.07182943820953369, 0.02844160422682762, -0.03693578764796257, 0.008027790114283562, -0.005927321966737509, 0.012375754304230213, 0.07831832766532898, 0.04873878136277199, -0.10403487831354141, -0.04351939260959625, -0.08668354153633118, -0.03932211548089981, 0.02763655222952366, 0.011531544849276543, 0.013437077403068542, -0.006039791274815798, -0.06558946520090103, -0.047920674085617065, 0.00580820394679904, -0.028242452070116997, -0.020932693034410477, -0.008625858463346958, -0.03473878651857376, -0.029247255995869637, 0.0119222616776824, -0.017870061099529266, 0.005186152644455433, 0.06339999288320541, 0.0065164570696651936, 0.04458212852478027, 0.0705055296421051, -0.04605732858181, 0.02653069794178009, -0.0223861001431942, -0.08274473994970322, 0.016392339020967484, 0.030355677008628845, 0.021623000502586365, 0.02566465176641941, -0.013003721833229065, 0.03358274698257446, 0.010662778280675411, 0.04327212646603584, -0.03448321670293808, -0.015363412909209728, 0.04563570395112038, 0.04983082041144371, -0.010748172178864479, 0.047605596482753754, -0.0836884006857872, 0.08087082952260971, -0.05633532628417015, -0.03773194178938866, -0.015635952353477478, -0.022203722968697548, 0.03514286130666733, 0.012465357780456543, 0.027079328894615173, 0.07432178407907486, -0.009279076009988785, -0.05258367210626602, -0.0074497973546385765, -0.06313414126634598, -0.020983131602406502, -0.0280836820602417, -0.04917754605412483, -0.04584836587309837, 0.03668273612856865, -0.07767646014690399, 0.13802602887153625, -0.1425284445285797, 0.07367141544818878, -0.007742193527519703, -0.05747736990451813, 0.06807569414377213, 0.058095768094062805, 0.006716954056173563, 0.01967761479318142, -0.024452438578009605, -0.024080399423837662, 0.127350851893425, 0.03846999257802963, -0.06865191459655762, 0.02927287295460701, 0.021443640813231468, -0.012852760963141918, -0.014884858392179012, 0.03288193792104721, -0.04195590317249298, -0.07765699177980423, -0.038791969418525696, 0.027321945875883102, -6.112144507573722e-34, -0.056422971189022064, 0.08318891376256943, -0.0986875370144844, 0.009194518439471722, -0.004164692480117083, -0.07076404243707657, -0.05368823930621147, 0.0048393066972494125, -0.0289356280118227, -0.040870606899261475, 0.035747528076171875, 0.019194629043340683, 0.03580255061388016, 0.11022092401981354, -0.08695759624242783, 0.07504700124263763, 0.03962777182459831, -0.0259237140417099, 0.02725704200565815, -0.022723088040947914, -0.004979106597602367, 0.0865827277302742, -0.05079134553670883, 0.09545053541660309, -0.01876937784254551, 0.004279203247278929, 0.06565456092357635, 0.04046325758099556, -0.028724430128932, -0.050819024443626404, -0.046595968306064606, -0.07116303592920303, 0.03925874084234238, 0.08173058927059174, 0.01894746534526348, 0.0038284403271973133, 0.10418479889631271, 0.008945117704570293, -0.04382522776722908, -0.012911145575344563, 0.06743338704109192, 0.02342916838824749, 0.05616297572851181, 0.06845350563526154, 0.055251799523830414, -0.0034476618748158216, 0.021970435976982117, -0.013742499053478241, 0.07004766911268234, 0.057238638401031494, 0.025053352117538452, 0.0730118453502655, -0.004149847198277712, -0.0005308580002747476, -0.06315913796424866, 0.005446065217256546, 0.08911944180727005, 0.03693484887480736, -0.033742982894182205, 0.08398845791816711, -0.01969180814921856, 0.08889377862215042, -0.013420197181403637, 0.0972907543182373, 0.07068386673927307, -0.01413329690694809, -0.048751093447208405, -0.12594109773635864, -0.008621752262115479, -0.08252112567424774, -0.10922804474830627, -0.03189745917916298, 0.02916541136801243, -0.0060394699685275555, -0.05090634152293205, -0.014758088625967503, 0.0834588035941124, 0.021379811689257622, 0.05794002488255501, 0.04504471272230148, -0.0265663955360651, -0.0027099086437374353, 0.0003376374952495098, 0.01949712075293064, -0.02369508147239685, -0.03200555965304375, -0.036631908267736435, -0.033952534198760986, 0.036769893020391464, -0.0004115069459658116, -0.01288408599793911, 0.0006474041729234159, -0.007201550528407097, -0.025384727865457535, -0.05480973422527313, -2.3931017167910795e-08, 0.039865005761384964, 0.08953584730625153, 0.0022053930442780256, -0.02300703339278698, 0.08658644556999207, 0.00934345182031393, 0.13000701367855072, 0.04840245470404625, -0.023434355854988098, 0.07312335073947906, 0.009286774322390556, 0.015102982521057129, -0.010175674222409725, -0.031851667910814285, -0.03445935249328613, -0.11665187776088715, -0.03152342513203621, -0.06131273880600929, -0.019666675478219986, -0.04384922608733177, 0.04134165123105049, 0.016903653740882874, 0.021548762917518616, 0.02014060690999031, -0.04858309403061867, -0.04470580443739891, -0.01652420312166214, 0.013476421125233173, -0.0072174896486103535, -0.0027295504696667194, -0.003690690966323018, 0.137552872300148, 0.023237204179167747, -0.06602246314287186, -0.015767890959978104, -0.02256152033805847, -0.03325315937399864, 0.012617052532732487, -0.022036314010620117, -0.03393176198005676, -0.05479765683412552, -0.07751110941171646, -0.038020871579647064, -0.018146928399801254, 0.08029143512248993, 0.0894521102309227, -0.005740501452237368, -0.11119461804628372, 0.10955702513456345, -0.13155514001846313, -0.03762296959757805, 0.04838487505912781, -0.00789747666567564, -0.011988853104412556, -0.016346126794815063, -0.056258514523506165, -0.06186294928193092, 0.03639372065663338, 0.06081665679812431, -0.015382267534732819, -0.0016131718875840306, -0.06995449215173721, -0.10604999214410782, 0.045426253229379654]
    search_query = {
        "size": num_results,
        "query": {
            "knn": {
                "vector": {
                    "vector": vector,
                    "k": num_results,
                    "boost": 1.0
                }
            }
        }
    }
    response = es_conn.search(index=index_name, body=search_query)
    for result_index, hit in enumerate(response['hits']['hits']):
        print("*** Top-"+str(result_index+1), "*** ID:", hit['_source']['doc_id'], ", Score:", hit['_score'], ", Sentence:", hit['_source']['sentence'])


if __name__ == "__main__":
    # query = "What is the main difference between the National Sample Survey (NSS) and the India Human Development Survey (IHDS) in terms of measuring India's inequality?"
    query = "When was the house at 3524 Redwing Ct, Naperville, IL 60564 last sold and for what price?"
    # "sentence": "National Sample Survey"
    index_name_data = "rag-dataset-12000-train"
    index_name_vector = "rag-dataset-12000-train-vector"
    print ("BM25 retrieval: ")
    search_data(query, index_name_data, 3)
    # print ()
    # print ("Dense retrieval: ")
    # search_vector(query, index_name_vector, 3)
